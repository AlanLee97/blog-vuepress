(window.webpackJsonp=window.webpackJsonp||[]).push([[113],{908:function(s,a,e){"use strict";e.r(a);var t=e(1),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"nginx-keepalived实现高可用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx-keepalived实现高可用"}},[s._v("#")]),s._v(" Nginx+Keepalived实现高可用")]),s._v(" "),e("h2",{attrs:{id:"准备资源"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#准备资源"}},[s._v("#")]),s._v(" 准备资源")]),s._v(" "),e("p",[s._v("2台Nginx，2台Tomcat")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("服务器")]),s._v(" "),e("th",[s._v("IP")]),s._v(" "),e("th",[s._v("端口")]),s._v(" "),e("th",[s._v("角色")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("基于ip的虚拟主机")]),s._v(" "),e("td",[s._v("192.168.1.20")]),s._v(" "),e("td",[s._v("80")]),s._v(" "),e("td",[s._v("MASTER")])]),s._v(" "),e("tr",[e("td",[s._v("Nginx - master - 2")]),s._v(" "),e("td",[s._v("192.168.1.200")]),s._v(" "),e("td",[s._v("80")]),s._v(" "),e("td",[s._v("BACKUP")])]),s._v(" "),e("tr",[e("td",[s._v("Tomcat - 1")]),s._v(" "),e("td",[s._v("192.168.1.21")]),s._v(" "),e("td",[s._v("8080")]),s._v(" "),e("td",[s._v("WEB SERVER")])]),s._v(" "),e("tr",[e("td",[s._v("Tomcat - 2")]),s._v(" "),e("td",[s._v("192.168.1.22")]),s._v(" "),e("td",[s._v("8080")]),s._v(" "),e("td",[s._v("WEB SERVER")])])])]),s._v(" "),e("h2",{attrs:{id:"安装keepalived"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装keepalived"}},[s._v("#")]),s._v(" 安装Keepalived")]),s._v(" "),e("p",[s._v("在2台Nginx下都安装Keepalived")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("yum -y install keepalived\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"配置keepalived"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置keepalived"}},[s._v("#")]),s._v(" 配置Keepalived")]),s._v(" "),e("p",[s._v("主要配置4个地方")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/AlanLee97/assert/raw/master/note_images/image-20200425095003540.png",alt:"image-20200425095003540"}})]),s._v(" "),e("h3",{attrs:{id:"主节点配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主节点配置"}},[s._v("#")]),s._v(" 主节点配置")]),s._v(" "),e("p",[s._v("修改主Nginx服务器的/etc/keepalived/keepalived.conf文件，内容如下")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("! Configuration File for keepalived\n\n#全局配置\nglobal_defs {\n   notification_email {  #指定keepalived在发生切换时需要发送email到的对象，一行一个\n     XXX@XXX.com\n   }\n   notification_email_from XXX@XXX.com  #指定发件人\n   #smtp_server XXX.smtp.com                             #指定smtp服务器地址\n   #smtp_connect_timeout 30                               #指定smtp连接超时时间\n   router_id LVS_DEVEL                                    #运行keepalived机器的一个标识\n}\n\nvrrp_instance VI_1 { \n    state MASTER           #标示状态为MASTER 备份机为BACKUP\n    interface ens33         #设置实例绑定的网卡\n    virtual_router_id 51   #同一实例下virtual_router_id必须相同\n    priority 100           #MASTER权重要高于BACKUP 比如BACKUP为99  \n    advert_int 1           #MASTER与BACKUP负载均衡器之间同步检查的时间间隔，单位是秒\n    authentication {       #设置认证\n        auth_type PASS     #主从服务器验证方式\n        auth_pass 8888\n    }\n    virtual_ipaddress {    #设置vip\n        192.168.1.100       #可以多个虚拟IP，换行即可\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br")])]),e("p",[s._v("查看ip")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/AlanLee97/assert/raw/master/note_images/image-20200425102447353.png",alt:"image-20200425102447353"}})]),s._v(" "),e("h3",{attrs:{id:"备用节点配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#备用节点配置"}},[s._v("#")]),s._v(" 备用节点配置")]),s._v(" "),e("p",[s._v("修改备用Nginx服务器的/etc/keepalived/keepalived.conf文件，内容如下")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("! Configuration File for keepalived\n\n#全局配置\nglobal_defs {\n   notification_email {  #指定keepalived在发生切换时需要发送email到的对象，一行一个\n     XXX@XXX.com\n   }\n   notification_email_from XXX@XXX.com  #指定发件人\n   #smtp_server XXX.smtp.com                             #指定smtp服务器地址\n   #smtp_connect_timeout 30                               #指定smtp连接超时时间\n   router_id LVS_DEVEL                                    #运行keepalived机器的一个标识\n}\n\nvrrp_instance VI_1 { \n    state BACKUP           #标示状态为MASTER 备份机为BACKUP\n    interface ens33         #设置实例绑定的网卡\n    virtual_router_id 51   #同一实例下virtual_router_id必须相同\n    priority 99           #MASTER权重要高于BACKUP 比如BACKUP为99  \n    advert_int 1           #MASTER与BACKUP负载均衡器之间同步检查的时间间隔，单位是秒\n    authentication {       #设置认证\n        auth_type PASS     #主从服务器验证方式\n        auth_pass 8888\n    }\n    virtual_ipaddress {    #设置vip\n        192.168.1.100       #可以多个虚拟IP，换行即可\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br")])]),e("p",[s._v("查看ip")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/AlanLee97/assert/raw/master/note_images/20200425112737-652506.png",alt:"image-20200425102552945"}})]),s._v(" "),e("p",[s._v("只有当主节点的Keepalived停掉时，备用节点才会生成虚拟ip")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/AlanLee97/assert/raw/master/note_images/20200425120320-891120.png",alt:"image-20200425120316441"}})]),s._v(" "),e("h2",{attrs:{id:"配置主从切换"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置主从切换"}},[s._v("#")]),s._v(" 配置主从切换")]),s._v(" "),e("p",[s._v("keepalived是通过检测keepalived进程是否存在判断服务器是否宕机，如果keepalived进程在但是nginx进程不在了那么keepalived是不会做主备切换，所以我们需要写个脚本来监控nginx进程是否存在，如果nginx不存在就将keepalived进程杀掉。")]),s._v(" "),e("p",[s._v("在主nginx上需要编写nginx进程检测脚本（check_nginx.sh），判断nginx进程是否存在，如果nginx不存在就将keepalived进程杀掉")]),s._v(" "),e("p",[e("strong",[s._v("check_nginx.sh内容如下：")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果进程中没有nginx则将keepalived进程kill掉")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("A")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -C nginx --no-header "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 查看是否有 nginx进程 把值赋给变量A ")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$A")]),s._v(" -eq "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("                    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 如果没有进程值得为 零")]),s._v("\n       "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" keepalived stop          "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 则结束 keepalived 进程")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[e("strong",[s._v("添加客执行权限")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x /etc/keepalived/check_nginx.sh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("修改主Nginx的配置")])]),s._v(" "),e("p",[s._v("添加如下两段代码")]),s._v(" "),e("p",[s._v("在vrrp_instance VI_1上面添加下面这段代码")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('vrrp_script check_nginx {\n    script "/etc/keepalived/check_nginx.sh"         ##监控脚本\n    interval 2                                      ##时间间隔，2秒\n    weight 2                                        ##权重\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("在virtual_ipaddress上面添加下面这段代码")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("track_script {\n\tcheck_nginx        #监控脚本\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h2",{attrs:{id:"访问测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#访问测试"}},[s._v("#")]),s._v(" 访问测试")]),s._v(" "),e("p",[s._v("启动keepalived")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" keepalived start\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("为了区分主备Nginx，修改一下Nginx主页")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/AlanLee97/assert/raw/master/note_images/20200425100407-304620.png",alt:"image-20200425100407097"}})]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/AlanLee97/assert/raw/master/note_images/20200425100502-880517.png",alt:"image-20200425100502281"}})]),s._v(" "),e("p",[s._v("浏览器访问虚拟ip，http://192.168.1.100/")]),s._v(" "),e("p",[s._v("首先进来的是主Nginx")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/AlanLee97/assert/raw/master/note_images/image-20200425100638472.png",alt:"image-20200425100638472"}})]),s._v(" "),e("p",[s._v("当停掉主Nginx，会访问到备用Nginx")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" nginx stop\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("再次访问http://192.168.1.100/，进入到备用Nginx")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/AlanLee97/assert/raw/master/note_images/image-20200425111547000.png",alt:"image-20200425111547000"}})])])}),[],!1,null,null,null);a.default=n.exports}}]);